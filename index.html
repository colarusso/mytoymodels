<!DOCTYPE HTML>
<HTMl>
<HEAD>

	<TITLE>My Toy Models</TITLE>
	<meta http-equiv="Content-type" content="text/html;charset=UTF-8"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link rel="apple-touch-icon" href="images/icon.png"/>

	<meta property="og:site_name" content="My Toy Models"/>
	<meta property="og:type" content="website"/>
	<meta property="og:title" content="My Toy Models"/>
	<meta property="og:description" content="If you‚Äôve ever wanted to ‚Äúrun a study‚Äù on some aspect of your personal life, this site is for you. It lets you ‚Äúscience the heck‚Äù out of your pet hypotheses‚Äîbuilding simple predictive models (regressions) around your data."/>
	<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Linear_regression.svg/580px-Linear_regression.svg.png"/>
	
	<link rel="stylesheet" type="text/css" href="css/main.css?v=2023-08-16.12:00">
	<link rel="stylesheet" type="text/css" href="css/spin.css?v=2023-08-16.12:00">
	<script src="js/model_lib.js?v=2023-08-16.12:00"></script>
	<script src="js/interactions.js?v=2023-08-16.12:00"></script>

	<!--<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>-->

	<script src="js/jquery-1.11.1.min.js"></script>
	
	<script src="js/spin/spin.min.js"></script>
	
	<script id="MathJax-script" async src="js/mathjax/tex-mml-chtml.js"></script>

	<script src="js/js-regression/jsregression.min.js" type="application/javascript"></script>

</HEAD>

<BODY BGCOLOR="#ffffff" BACKGROUND="" MARGINWIDTH="0" MARGINHEIGHT="0">
<div id="menu_bar" class="menu_bar">
  <a id="models_link" href="javascript:void('');" onClick="show_list();">Models</a>
  <input id="upload" type="file"/> 
  &nbsp;&nbsp;<a id="new_mod" href="javascript:void('');" onClick="load_state(1);make_new();">New</a>
  &nbsp;&nbsp;<a id="upload_link" href="javascript:void('');" onClick="upload_file(1);">Load</a>
  &nbsp;&nbsp;<a id="down_mod" href="javascript:void('');" onClick="save_model();">Download</a>
  <div style="float:right">
	<a id="run_mod" href="javascript:void('');" onClick="show_model();">Run</a>
	<a id="edit_mod" href="javascript:void('');" onClick="show_edit();">Edit</a>
  </div>
</div>

<div id="about" class="about">
	<h2>Your Toy Models</h2>
	<p>
	If you've ever wanted to "run a study" on some aspect of your personal life, this site is for you. It lets you "science the heck" out of your pet hypotheses‚Äîbuilding simple predictive models (<a href="https://en.wikipedia.org/wiki/Regression_analysis" target="_blank" class="body_links">regressions</a>) around your data. All the number crunching runs in your browser. So your data stays on your device (unless you activly download and share it, which I tried to make easy).  
	</p>
	<a href="https://mastodon.social/@Colarusso" target="_blank" class="body_links"><img src="images/colarusso.jpg" style="border-radius: 50%;float:left;width:50px;margin:0 15px 5px 0;"/></a>
	<p>
	Greetings dear reader, my name is <a href="https://mastodon.social/@Colarusso" target="_blank" class="body_links">David Colarusso</a>, and I <a href="https://www.codingthelaw.org" target="_blank" class="body_links">teach law students</a> about data, machine learning, and ‚ÄúAI.‚Äù I made this tool to help my students get a feel for <i>narrow AI</i> (machine learning) by building their own. As Richard Feynman observed, ‚Äúthat which I cannot create, I do not understand.‚Äù That being said, I don‚Äôt expect my students to become statisticians or data scientists. Rather, I want them to learn enough to understand the realm of the possible and to call BS when needed. To that end, this site lets you create your own <a href="https://en.wikipedia.org/wiki/Toy_model" target="_blank" class="body_links">toy models</a>, intentional simplifications that help folks explore the dynamics of a situation. That being said, keep in mind that this tools provided here are that dangerous mix of power and ease of use. If you can't make it to my class, please consult a <a href="https://hastie.su.domains/ElemStatLearn/printings/ESLII_print12_toc.pdf" target="_blank" class="body_links">statistics text</a> before assuming you know what they are telling you. ;)
	</p>
	<p>I haven't embedded analytics or tracking here, and all your data stays in your browser. I can't see it. My hope is this will free you to experiment honestly. But this means I don't know if folks are even using this tool. So, I'd appreciate you sharing what you're up to. You can find me <a href="https://mastodon.social/@Colarusso" target="_blank" class="body_links">@Colarusso@mastodon.social</a> or use <a href="https://docs.google.com/forms/d/e/1FAIpQLSfNN9v_A_wtILTMKuHIKFcRmMrq3CQSC1qgMZYCIlTGdBJnmA/viewform" target="_blank" class="body_links">this feedback form</a>.</p>

	<p>Want to look at the code or learn more about how to use this site? Check out <a href="https://github.com/colarusso/mytoymodels" target="_blank" class="body_links">this GitHub repo</a>. Regardless, you can get started by making a new model below.</p>

	<p><i>Note: This site was optimized for uses as a web app. So, you should <a href="https://www.androidauthority.com/add-website-android-iphone-home-screen-3181682/" target="_blank" class="body_links">add it to your home screen</a> if you're on a phone.</i></p>

	<hr style="border: 0px;border-top: 1px solid #555;margin:25px 0 15px 0;">
	<div id="first_button" class="button_container">
		<a href="javascript:void('')" onClick="make_new();" class="button">New Model</a>
	</div>
</div>

<div id="tos" class="tos"><h2>Terms of Service & Privacy</h2>
<p>Your data lives in your browser's  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" target="_blank" class="body_links">LocalStorage</a> unless you take affirmitive steps to download and share it (e.g., downlaoding a model). The training of all models is done in your browser. No warrantee is offered as to the acuracy of predictions made by models you or others authored. This site is intended to help users explore and become familiar with the promise and limitations of simple prediction algoritums. You can learn more and explore the site's code on <a href="https://github.com/colarusso/mytoymodels" target="_blank" class="body_links">its GitHub repo</a>. These terms are subject to change at anytime.</p>
<p>The site does NOT make use of tracking cookies or the like to measure engagement.</p>
<p>THE SITE IS PROVIDED ‚ÄúAS IS‚Äù, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SITE OR THE USE OR OTHER DEALINGS IN THE SITE.</p>
<hr style="border: 0px;border-top: 1px solid #555;margin:25px 0 15px 0;">
<p style="text-align:right;padding-right:10px;">Updated: 2023-08-16</p></div>
<div id="list_screen"><div id="list"></div></div>
<div id="lib_screen"><div id="list"></div></div>

<div id="new_model_screen" class="new_model_screen">
	<div id="new_model" class="new_model">
		<div class="l_img_embed" style="max-width:400px;">
			<img src="images/boxquote.png" alt="'All models are wrong, but some are useful.' - George Box" width="100%"/>
			<div class="caption">Maps are models; they don't show everything. That's okay as long as you don't confuse the map for the territory.</div>
		</div>
		A model providing an answer <a href="https://www.codingthelaw.org/Fall_2022/level/4/#intro_vid" target="_blank" class="body_links">isn't a guarantee</a> that it's "right." <a href="https://en.wikipedia.org/wiki/Toy_model" target="_blank" class="body_links">Toy models</a> are intentional simplifications meant to help folks understand how things relate to each other. This understanding, however, only comes through play. You need to know your subject matter and get your hands dirty looking at the data from all sides&mdash;tweaking this and fiddling with that. 
		<p>Maybe you'll create a sleep log and figure out when it's safe to have that last coffee or discover some feature you didn't think was important really is the best predictor of your mood but only if you take the time to explore possible features and collect lots of data. Even then, remember, correlation isn't causation; <a href="https://www.kdnuggets.com/2017/02/hill-data-scientist-xkcd-story.html" target="_blank" class="body_links">consider the context</a>. And beware, for if you torture the data long enough, it will <a href="https://en.wikipedia.org/wiki/Data_dredging" target="_blank" class="body_links">confess to anything</a>. <!--For more on model making, check out this short lecture.--></p>
		<p>Now go ahead, make a model.</p>
		<div class="button_container">
			<a href="javascript:void('')" onClick="show_lib();" class="button">From Library</a>
			<a href="javascript:void('')" onClick="upload_file();" class="button">From a File</a>
			<a href="javascript:void('')" onClick="show_build();" class="button">From Scratch</a>
		</div>
	</div>
</div>

<div id="build_new" class="build_new">
	<h2>Build A Model From Scratch</h2>
	<div id="input_question_type">
		<p>lorum ipsum</p>
		<h3>What do you want to do?</h3>
			<a href="javascript:void('')" onClick="new_model_type('continuous')" class="button">A Numeric Value</a>
		<a href="javascript:void('')" onClick="new_model_type('categorical')" class="button">Yes or No (odds of Yes)</a>
	</div>
	<div id="input_question">
		<p>
			<p>lorum ipsum</p>
			<h3>Your Question</h3>
			<input id="new_json_question">
			<p>lorum ipsum</p>
			<h3>Note (optional)</h3>
			<input id="new_json_note">
		</p>
		<hr style="border: 0px;border-top: 1px solid #555;margin:25px 0 15px 0;">
		<a href="javascript:void('')" onClick="new_model_feature()" class="button">Add Features</a>
	</div>
	<div id="input_question_target_options">
		<p>lorum ipsum</p>
		<h3>Target Options</h3>
		<p id="target_options_list">
			<input id="new_json_target_option_0">
			<input id="new_json_target_option_1">
		</p>
		<p id="remove_target_option" >
			<input type="button" onClick="remove_last_target()" style="background:rgb(255, 100, 100)" value="Remove Last"/>
		</p><p>
			<input type="button" onClick="add_target_option()" value="Add Option"/>
		</p>
		<a href="javascript:void('')" onClick="new_model_feature()" class="button">Add Features</a>
	</div>
	<div id="input_features">
		<p>
			<p>lorum ipsum</p>
			<h3>Feature Name</h3>
			<input id="new_json_feature_name">
			<p>lorum ipsum</p>
			<h3>More (optional)</h3>
			<input id="new_json_feature_more">
		</p>
		<p>
			<p>lorum ipsum</p>
			<h3>Type of Feature</h3>
			<select id="choose_type" oninput="new_model_feature_type(this.value)">
				<option value="choose">Choose One</option>
				<option value="continuous">Continuous</option>
				<option value="categorical">Categorical</option>
			</select>
		</p>
		<div id="feature_units">
			<p>lorum ipsum</p>
			<h3>Units</h3>
			<input id="new_json_feature_units">
			<p>lorum ipsum</p>
			<h3>Lower Limit</h3>
			<input id="new_json_feature_lower" type="number">
			<p>lorum ipsum</p>
			<h3>Upper Limit</h3>
			<input id="new_json_feature_upper" type="number">
			<p>lorum ipsum</p>
			<h3>Mean</h3>
			<input id="new_json_feature_mean" type="number">
		</div>
		<div id="feature_options">
			<p>lorum ipsum</p>
			<h3>Options</h3>
			<p id="feature_options_list">
				<input id="new_json_feature_option_0">
			</p>
			<p id="remove_option" >
				<input type="button" onClick="remove_last()" style="background:rgb(255, 100, 100)" value="Remove Last"/>
			</p><p>
				<input type="button" onClick="add_feature_option()" value="Add Option"/>
			</p>
		</div>
		<hr style="border: 0px;border-top: 1px solid #555;margin:25px 0 15px 0;">
		<div id="feature_next">
			<p>
				<a href="javascript:void('')" onClick="new_model_feature(1)" class="button">Add Another Feature</a>		
				<a href="javascript:void('')" onClick="finalize_model()" class="button">Finalize Model</a>		
			</p>
		</div>
	</div>
	<div id="forget">
		<a href="javascript:void('')" onClick="make_new()" class="button" style="background-color:red">Forget This Model</a>
	</div>
</div>

<div id="run">
	<div id="prediction" class="prediction">
		<h1 id="question_text">Loading...</h1>
		<h2 id="prediction_text">--</h2>
		<p>
			Based on <span id="n_entires"><i>n</i></span> <a href="javascript:void('');" onClick="arr2csv()">observations</a>
		</p>
	</div>
	<div id="features_wrapper">  
		<div id="features"></div>			
	</div>
</div>

<div id="ground_truth_screen" class="ground_truth_screen"></div>
<div id="training" class="training"><span id="spinner_here">&nbsp;</span></div>

<div id="edit_screen" class="edit_screen">
	<div id="edit" class="edit">
		<p>
			You can experiemnt with edits to your model below or read <a href="https://github.com/colarusso/mytoymodels#documenation" target="_blank" class="body_links">the documentation</a>.<sup>&dagger;</sup>
		</p>

		<textarea id="model_json" style="width:100%;height:55vh;" oninput="changes=1"></textarea>

		<div id="wrap_box" style="display: block;">
		<span style="float:right"><a href="javascript:void('');" onClick="arr2csv();" class="body_links">observations (CSV)</a></span>
		<label><input type="checkbox" id="wrap" name="wrap" value="1" onchange="toggle_wrap('');"> word wrap</label> 
		</div>
		<div class="button_container">
			<a href="javascript:void('')" onClick="save_changes();" class="button">Save Changes</a>
			<a href="javascript:void('')" onClick="save_and_train(1);" class="button">Save &amp; Train</a>
			<a href="javascript:void('')" onClick="delete_mod();" class="button" style="background:#c61c1c">Delete</a>
		</div>
		<div style="float:left;width:100%;margin:5px 0 70px 0;">
		<sup>&dagger;</sup> FWIW, the documenation discusses how to add advanced features like interaction terms.
		</div>
	</div>
</div>


<div id="footer" class="footer">
	<a id="about" href="javascript:void('');" onClick="show_about();">About</a> | 
	<a id="tos" href="javascript:void('')" onClick="show_tos()">Terms</a> | 
	<a id="feedback" href="https://docs.google.com/forms/d/e/1FAIpQLSfNN9v_A_wtILTMKuHIKFcRmMrq3CQSC1qgMZYCIlTGdBJnmA/viewform" target="_blank">Feedback</a>
	<span style="float: right;"><a id="mode" href="javascript:void('')" onClick="dark_mode(1)" style="text-decoration: none;">üåó</a></span>
</div>

</BODY>

<script type="text/javascript">

var changes = 0;
$(window).bind('beforeunload', function(){
  if (changes==1) {
    return 'Are you sure you want to leave? Changes will not be saved.';
  } else {
	return undefined
  }
});

function rethinkWindowSize() {
	$('#features_wrapper').css('top',($('#prediction').height()+40)+'px');
	$('#features_wrapper').scrollTop(0);
}

window.onresize = rethinkWindowSize;

$(window).on("orientationchange", function( event ) {
	rethinkWindowSize();
});

function dark_mode(change=null){
	if (localStorage.dark_mode) {
		m = localStorage.dark_mode
	} else {
		m = 0;
		localStorage.dark_mode = m;
	}
	if (change) {
		m = 1-m;
	}
	if(m==1){
		$('body').css("background","black"); 
		$('body').css("color","white");
		//$('about a:link').css("color","#0a9de7");
		$("#menu_bar").attr('class', 'menu_bar_dark');
		$("#list").attr('class', 'list_dark');
		$("div[class='list_item']").attr('class', 'list_item_dark');
		$("#prediction").attr('class', 'prediction_dark');
		$("a[class='body_links']").attr('class', 'body_links_dark');
		$("#footer").attr('class', 'footer_dark');
		$('#mode').html("üí°"); 
		$("input,textarea,select,.regression").css('opacity', 0.75) 
		localStorage.dark_mode = 1;
	} else {
		$('body').css("background","white"); 
		$('body').css("color","black"); 
		//$('body a:link').css("color","blue");
		$("#menu_bar").attr('class', 'menu_bar');
		$("#list").attr('class', 'list');
		$("div[class='list_item_dark']").attr('class', 'list_item');
		$("#prediction").attr('class', 'prediction');
		$("a[class='body_links_dark']").attr('class', 'body_links');
		$("#footer").attr('class', 'footer');
		$('#mode').html("üåó"); 
		$("input,textarea,select,.regression").css('opacity', 1) 
		localStorage.dark_mode = 0;
	}
}

var tmp = {}
var tmp_options = []
var tmp_targets = []
function new_model_type(type) {
	$('#new_json_question').val("");
	$('#new_json_note').val("");
	tmp = {}
	tmp["type"] = type;
	console.log("Building model...")
	console.log(tmp)
	// Leaving here in case I decide to support multiclass regression. See below too.
	//if (type=="categorical") {
	//	$('#target_options_list').empty();
	//	tmp_targets.push("new_json_target_option_0")
	//	$('#target_options_list').append(`<input id="new_json_feature_option_0">`)
	//	tmp_targets.push("new_json_target_option_1")
	//	$('#target_options_list').append(`<input id="new_json_feature_option_1">`)
	//	$('#forget').show();
	//	$('#input_question_type').hide();
	//	$('#input_question').hide();
	//	$('#input_question_target_options').show();
	//	window.scrollTo(0,0);
	//	$('#new_json_question').focus();
	//} else {
		$('#forget').show();
		$('#input_question_type').hide();
		$('#input_question').show();
		$('#input_question_target_options').hide();
		window.scrollTo(0,0);
		$('#new_json_feature_name').focus();	
		window.scrollTo(0,0);
		$('#new_json_question').focus();
	//}
}
function new_model_feature(mode=0) {
	console.log("Adding feature mode: "+mode);

	var error = ""

	if (tmp["type"]=="categorical") {
		tmp['target'] = {}
		tmp['target']['possible_answers'] = ['Yes', 'No']
		// Leaving here in case I decide to support multiclass regression. See above too.
		//for (x in tmp_targets){
		//	feature["categories"].push($('#'+tmp_targets[x]).val());
		//};
	}

	if (mode==0) {	
		console.log("Add question and description")
		tmp["question"] = $('#new_json_question').val();

		if (tmp["question"].trim()=="") {
			error += "You cannot leave the Your Question field blank. ";
		} else {
			if ($('#new_json_note').val().trim()!="") {
				tmp["description"] = $('#new_json_note').val();
			}
			tmp["features"] = []
		}

	} else {
		console.log("Add feature")
		var existing_features = tmp["features"].map(a => snake_case(a.name));

		console.log("Check pre-existing features. Is "+snake_case($('#new_json_feature_name').val())+" in ["+ String(tmp["features"].map(a => snake_case(a.name)))+"]?")
		if (existing_features.includes( snake_case($('#new_json_feature_name').val()) )) {
			error += "This feature name is too close to an existing feature name. ";
		}
		if ($('#new_json_feature_name').val().trim()=="") {
			error += "You cannot have empty feature name. "
		}

		error_sub = ""
		if ($('#choose_type').val()=="categorical") {
			for (x in tmp_options){
				if ($('#'+tmp_options[x]).val().trim()==""){
					error_sub = "You cannot have empty options. "
				}
			}
		} else {
			if ($('#new_json_feature_units').val().trim()=="") {
				error += "You cannot leave the Units field empty. ";
			}
			if ($('#new_json_feature_lower').val().trim()=="" |
				$('#new_json_feature_upper').val().trim()=="" |
				$('#new_json_feature_mean').val().trim()=="" |
				isNaN($('#new_json_feature_lower').val()*1) | 
				isNaN($('#new_json_feature_upper').val()*1) | 
				isNaN($('#new_json_feature_mean').val()*1)) {
				error += "Lower, Upper, and Mean must all be numbers. ";
			} 
		}

		error += error_sub;
		if (error=="") {
			feature = {}
			feature["name"] = $('#new_json_feature_name').val();
			if ($('#new_json_feature_more').val().trim()!="") {
				feature["description"] = $('#new_json_feature_more').val();
			}
			if ($('#choose_type').val()=="continuous") {
				feature["type"] = "continuous"
				feature["units"] = $('#new_json_feature_units').val();
				feature["lower"] = $('#new_json_feature_lower').val()*1;
				feature["upper"] = $('#new_json_feature_upper').val()*1;
				feature["mean"] = $('#new_json_feature_mean').val()*1;
			} else if ($('#choose_type').val()=="categorical") {
				feature["type"] = "categorical"
				feature["categories"] = []
				feature["weights"] = []
				for (x in tmp_options){
					feature["categories"].push($('#'+tmp_options[x]).val());
					feature["weights"].push(1);
				};
			}
			tmp["features"].push(feature)
		}
	}

	if (error!=""){
		alert(error + "Make changes, and try again.")
	} else {
		if (mode!=2) {
			$('#new_json_feature_name').val("");
			$('#new_json_feature_more').val("");

			$('#input_question_type').hide();
			$('#input_question').hide();
			$('#input_question_target_options').hide();
			$('#input_features').show();
			$('#feature_units').hide();
			$('#feature_options').hide();
			$('#feature_next').hide();
			$("#choose_type").val("choose");
			window.scrollTo(0,0);
			$('#new_json_feature_name').focus();	
			console.log("Building model...")
			console.log(tmp)
		}
	}
	return error

}
function new_model_feature_type(type) {
	if (type=="choose"){
		$('#feature_units').hide();
		$('#feature_options').hide();
		$('#feature_next').hide();
	} else if (type=="continuous"){
		$('#new_json_feature_units').val("");
		$('#new_json_feature_lower').val("");
		$('#new_json_feature_upper').val("");
		$('#new_json_feature_mean').val("");
		$('#feature_units').show();
		$('#feature_options').hide();
		$('#feature_next').show();
	} else if (type=="categorical") {
		$('#feature_options_list').empty();
		tmp_options = ["new_json_feature_option_0"];
		$('#feature_options_list').append(`<input id="new_json_feature_option_0">`)
		tmp_options.push("new_json_feature_option_1")
		$('#feature_options_list').append(`<input id="new_json_feature_option_1">`)
		$('#remove_option').hide();
		$('#feature_units').hide();
		$('#feature_options').show();
		$('#feature_next').show();
		dark_mode();
		$('#new_json_feature_option_0').focus();		
	}
}
function add_feature_option() {
	input_id = `new_json_feature_option_`+String(tmp_options.length);
	$('#feature_options_list').append(`<input id="`+input_id+`">`)
	$('#'+input_id).focus();		
	tmp_options.push(input_id)
	$('#remove_option').show();
	dark_mode();
}
function remove_last() {
	if (tmp_options.length>=3) {
		input_id = `new_json_feature_option_`+String(tmp_options.length-1);
		var index = tmp_options.indexOf(input_id);
		if (index !== -1) {
			tmp_options.splice(index, 1);
		}
		$('#'+input_id).remove();
		input_id = `new_json_feature_option_`+String(tmp_options.length-1);
		$('#'+input_id).focus();
	} else {
		alert("You must have at least two options. ")
	}
}
function add_target_option() {
	input_id = `new_json_target_option_`+String(tmp_targets.length);
	$('#target_options_list').append(`<input id="`+input_id+`">`)
	$('#'+input_id).focus();		
	tmp_targets.push(input_id)
	$('#remove_target_option').show();
	dark_mode();
}
function remove_last_target() {
	if (tmp_targets.length>=3) {
		input_id = `new_json_target_option_`+String(tmp_targets.length-1);
		var index = tmp_targets.indexOf(input_id);
		if (index !== -1) {
			tmp_targets.splice(index, 1);
		}
		$('#'+input_id).remove();
		input_id = `new_json_target_option_`+String(tmp_targets.length-1);
		$('#'+input_id).focus();
	} else {
		alert("You must have at least two options. ")
	}
}
function finalize_model() {

	error = new_model_feature(mode=2);

	if (error=="") {
		// add coefficents and number et al
		console.log("Writing coefficients et al.")
		tmp['training'] = {}
		tmp['training']['headers'] = []
		tmp['training']['observations'] = []
		tmp['training']['headers'].push("recorded_on");
		tmp['trained_on'] = 0,
		tmp['coefficients'] = {}
		tmp["features"].forEach((element,index) => {
			console.log(element)
			if (element["type"]=="continuous") {
				variable_name = snake_case(element["name"]);
				tmp['coefficients'][variable_name] = 0;
				tmp['training']['headers'].push(variable_name);
			} else if (element["type"]=="categorical") {
				for (cat in element["categories"]) {
					variable_name = snake_case(element["name"])+`-`+snake_case(element["categories"][cat]);
					tmp['coefficients'][variable_name] = 0;
					tmp['training']['headers'].push(variable_name);
				}
			}
		})
		tmp['training']['headers'].push("target");
		tmp['training']['headers'].push("note");
		tmp['coefficients']['intercept'] = 0;
		tmp['performance'] = {}
		console.log("Building model...")
		console.log(tmp)
		var question_arr = JSON.parse(localStorage.questions)
		question_arr.unshift(tmp);
		localStorage.questions = JSON.stringify(question_arr)
		show_list();
	}

}

function show_about(){
	console.log("Show About Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "About My Toy Models";
		$('#about').show();
		$('#tos').hide();
		$('#list_screen').hide();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "about";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);
	}
}

function show_tos(){
	console.log("Show ToS Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "Terms of Service";
		$('#about').hide();
		$('#tos').show();
		$('#list_screen').hide();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "tos";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);
	}
}


function show_list() {
	console.log("Show List Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "My Toy Models";
		$('#list').empty();
		i = 0;
		for (question in JSON.parse(localStorage.questions)) {
			$('#list').append(`<div class="list_item" onclick="localStorage.removeItem('feature_values');load_model(`+i+`);show_model(`+i+`);"><div style="float:right;height:100%;padding:0 0px 15px 15px;">></div>`+JSON.parse(localStorage.questions)[question]["question"]+`</div>`);
			i+=1;
		}
		$('#list').append(`<div class="button_container" style="padding:0 15px;"><a href="javascript:void('')" onClick="make_new();" class="button">New Model</a><a href="javascript:void('')" onClick="delet_all_models();" class="button" style="background:red">Delete ALL Models</a>
		<p><i>Note: To remove a single model, navigate to the model's "Edit" screen, then choose "Delete."</i></p></div>	`);

		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').show();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "list";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'none');
		$('#models_link').css('font-weight', 'bold');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);

		mem_usage();
	}
}

function show_lib() {
	console.log("Show Library Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "Library of Toy Models";
		$('#list').empty();
		i = 0;
		for (question in library) {

			if (!(typeof library[question]["description"] === 'undefined')) {
				description = library[question]["description"];
			} else {
				description = "";
			}

			$('#list').append(`<div class="list_item" onclick="load_lib_model(`+i+`);show_list();"><div style="float:right;height:100%;padding:0 0px 15px 15px;"><span class="plus">+</span></div>Add <b><i>`+library[question]["question"]+`</i></b> to <i>Models</i>. `+description+`</div>`);
			i+=1;
		}
		$('#list').append(`<div class="button_container" style="padding:0 15px;"><a href="javascript:void('')" onClick="make_new();" class="button">New Model</a></div>`);

		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').show();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "lib";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);
	}
}

function make_new() {
	console.log("Show Make New Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "Make New Model";
		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').hide();
		$('#new_model_screen').show();
		$('#input_question_target_options').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "new";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').hide();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);
	}
}


function show_build(){
	console.log("Show Build New Screen")
	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		document.title = "Build Model From Scratch";
		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').hide();
		$('#new_model_screen').hide();
		$('#build_new').show();
		$('#input_question_type').show();
		$('#input_question').hide();
		$('#input_features').hide();
		$('#forget').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "new";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();
		dark_mode();
		window.scrollTo(0,0);
	}
}


function show_model() {
	console.log("Show Model Screen")

	model = JSON.parse(localStorage.questions)[0]
	features = model["features"];
	feature_list = features.map(features => snake_case(features.name));
	feature_list.push("note");
	coefficients = model["coefficients"];

	if ( (localStorage.feature_values) && (feature_list.sort().join('/')==Object.keys(JSON.parse(localStorage.feature_values)).sort().join('/')) ) {
		feature_values = JSON.parse(localStorage.feature_values);
		console.log("Load saved feature values: ",feature_values)
	} else {
		var feature_values = {"note":""};
		for (feature in feature_list) {
			features.forEach((element,index) => {
				if (feature_list[feature]==snake_case(element["name"])) {
					if (element["type"]=="continuous") {
						feature_values[snake_case(feature_list[feature])] = element["mean"];
					} else if (element["type"]=="categorical") {
						console.log(feature_list[feature],element["categories"][ element["weights"].indexOf(Math.max(...element["weights"])) ])
						feature_values[feature_list[feature]] = snake_case(element["categories"][ element["weights"].indexOf(Math.max(...element["weights"])) ]);
					}
				}
			})
		}
		localStorage.feature_values = JSON.stringify(feature_values);
		console.log("Load default feature values: ",feature_values)
	}

	html = '<h2>Inputs/Features</h2>';
	features.forEach((element,index) => {
			html += `<div class="feature">`;
			if (element["type"]=="continuous") {
				tail_diff = element["upper"] - element["mean"];
				if (tail_diff< (element["mean"] - element["lower"])) {
					tail_diff = element["mean"] - element["lower"];
				}
				est_std = tail_diff/3
				step_size = 10**(Number.parseFloat(est_std).toExponential(2).split("e")[1]-2);
				html += `<b>`+(index+1)+`) `+element["name"]+`:</b>	<span id="`+snake_case(element["name"])+`">`+feature_values[snake_case(element["name"])]+`</span> (<span id="`+snake_case(element["name"])+`_units">`+element["units"]+`</span>)<p>`;
				if (element["description"]){
					html += `<p>`+element["description"]+`</p>`;
				}
				html += `<input type="range" min="`+element["lower"]+`" max="`+element["upper"]+`" value="`+feature_values[snake_case(element["name"])]+`" class="slider" id="myRange" class="slider" oninput="$('#`+snake_case(element["name"])+`').html(this.value);run_model();" step="`+step_size+`">`;
			} else if (element["type"]=="categorical") {
				html += `<b>`+(index+1)+`) `+element["name"]+`:</b><p>`;			
				html += `<select id="`+snake_case(element["name"])+`" oninput="run_model();">`;
					for (cat in element["categories"]) {
						html += `<option value="`+element["categories"][cat]+`"`;
						if (snake_case(element["categories"][cat])==feature_values[snake_case(element["name"])]) {
							html += ` selected`;
						}
						feature_values[element["name"]]
						html += `>`+element["categories"][cat]+`</option>`;
					}
				html += `<select>`;
			}
			html += `</p>
			</div>`;
	})

	html += `<!-- Check for change to notes and features and make sure folks know when they will be lost-->
			<p><b>NOTE (optional):</b></p>
			<p>
				<textarea id="note" style="width:100%;height:70px" oninput="tmp=JSON.parse(localStorage.feature_values);tmp['note']=this.value;localStorage.feature_values = JSON.stringify(tmp);">`+feature_values["note"]+`</textarea></p>
			<p>
				<a href="javascript:void('')" onClick="ground_truth();" class="button" style="margin-bottom: 20px;">Log Ground Truth</a>
			</p>
			<p>
				<sup>&dagger;</sup>
				Here's the regression behind this prediction:

				<div id="regression" class="regression">`

	model_html = ``
	if (model["type"]=="continuous") {
		model_html += `\\[y = B_0`;
	} else if (model["type"]=="categorical") {
		model_html += `\\[p(x) = {{1} \\over {1 + e^{-1(B_0`
	}	
	
	given_html = ``;
	if (model["type"]=="continuous") {
		given_html += `<li>\\(y\\) is the predicted value of your answer</li>`;
	} else if (model["type"]=="categorical") {
		given_html += `<li>\\(p(x)\\) is the probability the answer is <i>Yes</i></li>`;
	}
	//given_html += `<li>\\(B_0\\) is the <i>intercept</i> with value = `+Math.round(coefficients["intercept"]*100)/100+`</li>`;
	given_html += `<li>\\(B_0\\) is the <i>intercept</i> with value = `+coefficients["intercept"].toExponential(2)+`</li>`;

	var i = 1;
	features.forEach((element,index) => {
		if (element["type"]=="continuous") {
			variable_name = snake_case(element["name"]);
			given_html += `<li>\\(x_`+i+`\\) is <i>`+variable_name+`</i> measured in <i>`+element["units"]+`</i></li> `;
			//given_html += `<li>\\(B_`+i+`\\) is a coefficient with value <i>`+Math.round(coefficients[variable_name]*100)/100+`</i></li> `;
			given_html += `<li>\\(B_`+i+`\\) is a coefficient with value <i>`+coefficients[variable_name].toExponential(2)+`</i></li> `;
			model_html += `+ x_`+i+`*B_`+i;
			i += 1;
		} else if (element["type"]=="categorical") {
			for (cat in element["categories"]) {
				variable_name = snake_case(element["name"])+`-`+snake_case(element["categories"][cat]);
				given_html += `<li>\\(x_`+i+`\\) is the binary variable <i>`+variable_name+`</i>`;
				//given_html += `<li>\\(B_`+i+`\\) is a coefficient with value <i>`+Math.round(coefficients[variable_name]*100)/100+`</i></li> `;
				given_html += `<li>\\(B_`+i+`\\) is a coefficient with value <i>`+coefficients[variable_name].toExponential(2)+`</i></li> `;
				model_html += `+ x_`+i+`*B_`+i;
				i += 1;
			}
		}
	})

	if (model["type"]=="continuous") {
		model_html += `\\]`;
	} else if (model["type"]=="categorical") {
		model_html += `)}}}\\]`;		
	}	

	html += model_html + `</div>
				Where:
				<ul>`;
	html += given_html + `</ul>`;

	html_ondex = `<p>Curent Model Performance:<sup>*</sup></p>
			<ul>
				<li><a href="" target="_blank" class="body_links">R-squared</a> = 0.5</li>
				<li><a href="" target="_blank" class="body_links">accuracey</a> = 0.5</li>
			</ul>
			<sup>*</sup>Arrived at using k-folds 
		</p>
	</div>`;

	$('#features').empty();
	$('#features').append(html);
	try {
		MathJax.typeset();		
	} catch (error) {}

	var go = 1;
	if (changes==1) {
		let text = "You've made changes to your model without saving. Press OK to discard these changes and leave this page, or press Cancel to stay here.";
		if (confirm(text) != true) {
			go = 0;
		}
	}
	if (go==1) {
		changes = 0;
		//load_model();
		document.title = "Model: "+JSON.parse(localStorage.questions)[0]["question"];
		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').hide();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').show();
		$('#ground_truth_screen').hide();	
		$('#training').hide();	
		$('#edit_screen').hide();
		localStorage.screen = "run";
		$('#models_link').show();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').show();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').show();
		dark_mode();
		rethinkWindowSize();
		run_model();
	}
}

function ground_truth() {
	console.log("Show Log Ground Truth Screen")

	model = JSON.parse(localStorage.questions)[0]

	$('#ground_truth_screen').empty();
	html = "<h2>Log Ground Truth</h2>"
	html += "<p>Input and record the outcome/target value for the observations made on the last screen.</p><p>"

	if (model["type"]=="continuous"){
		html += `<input name="target" id="target" type="number" style="width:100%"/>`;
	} else if (model["type"]=="categorical"){
		html += `<select id="target" style="width:100%">`;
		for (x in model["target"]["possible_answers"]) {
			html += `<option value='`+model["target"]["possible_answers"][x]+`'>`+model["target"]["possible_answers"][x]+`</option>`;
		}
		html += `</select>`;
	}

	html += `</p><div class="button_container"><a href="javascript:void('')" onClick="save_obs();" class="button";">Save Observation</a>`
	html += `<a href="javascript:void('')" onClick="save_and_train(0);" class="button">Save and Train</a>`
	html += `<a href="javascript:void('')" onClick="show_model();" class="button">Go Back W/O Saving</a></div>`

	$('#ground_truth_screen').append(html);

	setTimeout(function(){
    	$('#target').focus();
	});

	$('#about').hide();
	$('#tos').hide();
	$('#list_screen').hide();
	$('#new_model_screen').hide();
	$('#build_new').hide();
	$('#run').hide();
	$('#ground_truth_screen').show();	
	$('#training').hide();	
	$('#edit_screen').hide();
	localStorage.screen = "run";
	$('#models_link').hide();
	$('#models_link').css('text-decoration', 'underline');
	$('#models_link').css('font-weight', 'normal');
	$('#new_mod').hide();
	$('#upload_link').hide();
	$('#down_mod').hide();
	$('#run_mod').hide();
	$('#edit_mod').hide();

}

function save_obs(mode=1) {
	console.log("Save Observations")

	if ($('#target').val().trim()=="") {
		alert("There is a problem with your target value. Check it and try again. ")
		return false
	} else {

		models = JSON.parse(localStorage.questions)
		model = models[0]
		headers = model["training"]["headers"]
		feature_values = JSON.parse(localStorage.feature_values);
		feature_values["recorded_on"] = new Date().toISOString().split('T')[0];
		feature_values["target"] = $('#target').val();

		row = []
		for (column in headers) {
			if (!headers[column].includes("-")) {
				if (feature_values[headers[column]]*1) {
					row.push(feature_values[headers[column]]*1)
				} else {
					row.push(feature_values[headers[column]])
				}
			} else {
				if (headers[column].split("-")[1]==feature_values[headers[column].split("-")[0]]) {
					row.push(1)
				} else {
					row.push(0)
				}
			}
		}
		
		console.log("Saving ground truth...")
		console.log("Headers: "+headers.join(","))
		console.log("Values: ")
		console.log(row)

		model["training"]["observations"].push(row) 
		models[0] = model
		localStorage.questions = JSON.stringify(models);

		localStorage.removeItem('feature_values');
		mem_usage();

		if (mode==1) {
			load_model();
			show_model();
		}
		return true
	}

}

function save_and_train(mode=0) {
	console.log("Save and Train")

	if (mode==0) {
		go = save_obs();
	} else {
		go = 1;
	}

	if (go) {
		//save_changes();

		$('#spinner_here').empty();
		if (localStorage.dark_mode==1) {
			tickcolor = '#ddd';		
		} else {
			tickcolor = '#000';		
		}
		start_spinner('spinner_here',tickcolor);

		$('#about').hide();
		$('#tos').hide();
		$('#list_screen').hide();
		$('#new_model_screen').hide();
		$('#build_new').hide();
		$('#run').hide();
		$('#ground_truth_screen').hide();	
		$('#training').show();	
		$('#edit_screen').hide();
		//localStorage.screen = "run";
		$('#models_link').hide();
		$('#models_link').css('text-decoration', 'underline');
		$('#models_link').css('font-weight', 'normal');
		$('#new_mod').hide();
		$('#upload_link').hide();
		$('#down_mod').hide();
		$('#run_mod').hide();
		$('#edit_mod').hide();

		passed = train_model();

		setTimeout(function(){
			if (!passed) {
				if (mode==0) {
					alert("Unable to build model! Any observations have been saved, but more data is needed. Add more and try again.")
				} else {
					alert("Unable to build model! More observationsa are needed. Add more and try again.")
				}
			} else {
				save_changes();
			}
			load_model();
			if (mode==0) {
				show_model();
			} else {
				show_edit();
			}
		},1000);
	}
}

function delet_all_models() {
	let text = "Press OK to delete ALL OF YOUR MODELS, or press Cancel to stay here.";
	if (confirm(text) == true) {
		//localStorage.removeItem("questions");
		localStorage.questions = "[]";
		load_model();
		show_list();
		console.log("DELETING ALL MODELS!")
	}
}

function show_edit() {
	console.log("Show Edit Screen")

	document.title = "Edit: "+JSON.parse(localStorage.questions)[0]["question"];
	$('#about').hide();
	$('#tos').hide();
	$('#list_screen').hide();
	$('#new_model_screen').hide();
	$('#build_new').hide();
	$('#run').hide();
	$('#ground_truth_screen').hide();	
	$('#training').hide();	
	$('#edit_screen').show();
	localStorage.screen = "edit";
	$('#models_link').show();
	$('#models_link').css('text-decoration', 'underline');
	$('#models_link').css('font-weight', 'normal');
	$('#new_mod').show();
	$('#upload_link').show();
	$('#down_mod').show();
	$('#run_mod').show();
	$('#edit_mod').hide();
	dark_mode();
	window.scrollTo(0,0);
	$('#model_json').scrollTop(0); 

	check_wrap();
}


function load_model(n=0){
	console.log("Load Model")

	if (localStorage.questions!="[]"){
		var question_arr = JSON.parse(localStorage.questions)
		question_arr.unshift(question_arr.splice(n, 1)[0]);
		localStorage.questions = JSON.stringify(question_arr)
		question = question_arr[0]["question"]
		$('#model_json').val(JSON.stringify(question_arr[0], null, 2))
		//document.title = question;
		$('#question_text').html(question);
		$('#prediction_text').html("--<sup>&dagger;</sup>");
		if (question_arr[0]["trained_on"]) {
			$('#n_entires').html(question_arr[0]["trained_on"]);
		} else {
			$('#n_entires').html('<i>n</i>');
		}
		$('#features_wrapper').css('top',($('#prediction').height()+40)+'px'); 
		$('#features_wrapper').scrollTop(0);
	}
}

function load_lib_model(n=0){
	console.log("Add Library Model to My Models")

	var question_arr = JSON.parse(localStorage.questions)
	question_arr.unshift(library[n]);
	//question_arr.unshift(question_arr.splice(n, 1)[0]);
	localStorage.questions = JSON.stringify(question_arr)
	question = question_arr[0]["question"]
	$('#model_json').val(JSON.stringify(question_arr[0], null, 2))
	//document.title = question;
	$('#question_text').html(question);
	$('#prediction_text').html("--<sup>&dagger;</sup>");
	if (question_arr[0]["trained_on"]) {
		$('#n_entires').html(question_arr[0]["trained_on"]);
	} else {
		$('#n_entires').html('<i>n</i>');
	}
	$('#features_wrapper').css('top',($('#prediction').height()+40)+'px'); 
	$('#features_wrapper').scrollTop(0);
}

function snake_case(text){
	text = text.trim().toLowerCase();
	text = text.replace(/[^a-zA-Z0-9]/g,"_");
	text = text.replace(/_+/g,"_");
	text = text.replace(/^_+|_+$/g, '');
	return text
}

function upload_file() {
	console.log("Upload File")
    $("#upload:hidden").trigger('click');
}

function format_check(json){
	console.log("Check JSON format")
	var output;
	if ((json["question"]) && 
		(json["type"]) && 
		(Object.keys(json["features"]).length>0) && 
		(Object.keys(json["coefficients"]).length>1) && 
		(!Number.isNaN(json["coefficients"]["intercept"]))) {
		output = ""
	} else {
		output = "Please check your code, edit, and try again.";	
	}
	return output
}

function mem_limit() {
	console.log("Find Memory Limit")
	//if (localStorage && !localStorage.getItem('mem_limit')) {
	//	var i = 0;
	//	try {
			// Test up to 10 MB
	//		for (i = 250; i <= 10000; i += 250) {
	//			localStorage.setItem('mem_test', new Array((i * 1024) + 1).join('a'));
	//		}
	//	} catch (e) {
	//		localStorage.removeItem('mem_test');
	//		localStorage.setItem('mem_limit', i - 250);            
	//	}
	//	return true
	//} else {
	//	return false
	//}
	localStorage.setItem('mem_limit', 5000);   
}

function mem_usage() {
	new_check = mem_limit();
	if (new_check) {
		console.log("MEMORY REPORT");
	}
	var _lsTotal = 0,
    _xLen, _x;
	for (_x in localStorage) {
		if (!localStorage.hasOwnProperty(_x)) {
			continue;
		}
		_xLen = ((localStorage[_x].length + _x.length) * 2);
		_lsTotal += _xLen;
		if (new_check) {
			console.log(" - " + _x.substr(0, 50) + " = " + (_xLen / 1024).toFixed(2) + " KB")
		}
	};
	kbs = (_lsTotal / 1024).toFixed(2)
	percentage = (_lsTotal / 1024).toFixed(2)/localStorage.mem_limit	
	console.log("Memory Check: " + Math.round(percentage*10000)/100 + "% (" + kbs + "KB/" + localStorage.mem_limit + "KB)");

	if (percentage>=0.4) {
		alert('Your model library is taking up '+ kbs + " KB. Consider saving some of your data to file(s) and deleting them from here to free up space.")
	}
}

function arr2csv(){
	console.log("Convert Array to CSV")
	csv = JSON.parse(localStorage.questions)[0]["training"]["observations"] 
	csv.unshift(JSON.parse(localStorage.questions)[0]["training"]["headers"])

	csv_text = "";

	for(var i=0; i<csv.length; i++){
		row = csv[i]
		for(var j=0; j<row.length; j++){
			if (j>0) {
				csv_text += ","
			}
    		csv_text += JSON.stringify(row[j]);
		}
		csv_text += "\n";
	}

	filename = snake_case(JSON.parse(localStorage.questions)[0]["question"]).slice(0,25);
	saveTextAsFile(csv_text,"observations-"+filename+".csv");
}

//===========================================
// Data handling
//===========================================
// h/t http://answers.splunk.com/answers/125819/fill-textarea-from-a-file.html

var control = document.getElementById("upload");
control.addEventListener("change", function(event){
	if (window.File && window.FileReader && window.FileList && window.Blob) {
		var reader = new FileReader();
			reader.onload = function(event){
				this_model = event.target.result;
				try {
					error_msg = format_check(JSON.parse(this_model));					
				} catch (error) {
					error_msg = "Error loading file.";
				}
				if (error_msg.length>0) {
            		alert("There is a problem with this file's format. " + error_msg);
        		} else {
					if (localStorage.screen=="edit"){
						let text = "Loading this file will overwrite the current model.";
  						if (confirm(text) == true) {
							q_arr = JSON.parse(localStorage.questions);
							q_arr[0] = JSON.parse(this_model)
							localStorage.questions = JSON.stringify(q_arr);
							load_model();
							show_edit();
						}
					} else {
						localStorage.questions = JSON.stringify([JSON.parse(this_model)].concat(JSON.parse(localStorage.questions)));
						show_list();
					}
				}

			};
			reader.onerror = function(event){
				console.error("File could not be read! Code " + event.target.error.code);
			};
			//console.log("Filename: " + control.files[0].name);
			reader.readAsText(control.files[0]);
	} else {
		alert('This feature is not supported by your browser.');
	}
}, false);

//===========================================
// Custom keypress events
//===========================================

var mouseDown = 0;
document.body.onmousedown = function() { 
  ++mouseDown;
}
document.body.onmouseup = function() {
  --mouseDown;
  if (localStorage.screen=="run") {
	  console.log(equation)
  }
}

$('#reply').keypress(function(e){
	if(e.keyCode == 13 && !e.shiftKey) {
		e.preventDefault();
		answer_button();
	}
});

function delete_mod(n) {
  console.log("Delete Model")
  let text = "Press OK to delete this model and its data or Cancel to do nothing.";
  if (confirm(text) == true) {
	localStorage.removeItem("feature_values"); 
	var question_arr =  JSON.parse(localStorage.questions)
	var tmp = question_arr.shift();
	localStorage.questions = JSON.stringify(question_arr);
	show_list();
  }
}

function check_wrap(){
	console.log("Check Word Wrap")
	if (localStorage.word_wrap == 1) {
		$( "#wrap" ).prop( "checked", true );
		document.getElementById('model_json').wrap = "soft";
	} else {
		document.getElementById('model_json').wrap = "off";	
	}
}

// toggle wrap 
function toggle_wrap(value) {
	console.log("Toggle Word Warp")
	if (document.getElementById('wrap').checked) {
		document.getElementById('model_json').wrap = "soft";
		localStorage.word_wrap = 1;
	} else {
		document.getElementById('model_json').wrap = "off";	
		localStorage.word_wrap = 0;
	}
	//document.getElementById('model_json').value = document.getElementById('model_json').value
}	

// https://stackoverflow.com/a/68259380
//var editor = CodeMirror.fromTextArea(document.getElementById('model_json'), {
//    lineNumbers: true,
    //mode: 'text/javascript',
//    matchBrackets: true,
//});

function load_page() {
	console.log("Load Screen")

	if (!localStorage.questions) {
		localStorage.questions = "[]";
	}

	load_model();
	
	if (localStorage.screen=="list") {
		show_list();
	} else if (localStorage.screen=="lib") {
		show_lib();
	} else if (localStorage.screen=="new") {
		make_new();
	} else if (localStorage.screen=="run") {
		show_model();
	} else if (localStorage.screen=="edit") {
		show_edit();
	} else if (localStorage.screen=="tos") {
		show_tos();
	} else {
		show_about();
	}

	setTimeout(function(){
			mem_usage();
	});	
	//start_spinner('loading_box');
	//passcheck();
}

window.onpaint = load_page();

function save_changes() {
	console.log("Save Model")
	try {
		var question_arr = JSON.parse(localStorage.questions);
		active_json = JSON.parse($('#model_json').val());
		error_msg = format_check(active_json);
		if (error_msg.length==0) {
			question_arr[0] = active_json;
			localStorage.questions = JSON.stringify(question_arr);
			changes = 0;
		} else {
			alert("There was an issue with your json format. No changes have been saved. " + error_msg)
		}		
	} catch (error) {
		alert("There was an issue with your json format. No changes have been saved. ")
	}
}

function wrangle() {
	console.log("Wrangle Observation Data")
	data = JSON.parse(localStorage.questions)[0]["training"]["observations"] 
	//data.unshift(JSON.parse(localStorage.questions)[0]["training"]["headers"])
	var removeIndexes = [0,data[0].length-1]
	data = data.map(v => v.filter((_, i) => !removeIndexes.includes(i)))
	for(var i=0; i<data.length; i++){
		row = data[i]
		j = row.length-1;
		if (typeof row[j] == "string") {
			if (row[j].toLowerCase()=="yes") {
				data[i][j] = 1;
			} else if (row[j].toLowerCase()=="no") {
				data[i][j] = 0;
			}
		}
	}
	return data
}

var r_model;
var regression;
var logistic;
function train_model(mode=0){
	console.log("Train Model")

	try {
			
		models = JSON.parse(localStorage.questions)
		this_model = models[0]

		data = wrangle();
		
		console.log("Type: "+this_model["type"])
		console.log(data)

		// https://github.com/chen0040/js-regression

		if (this_model["type"]=="continuous") {
			console.log("Linear Regressions")
			// === Create the linear regression === //
			regression = new jsregression.LinearRegression({
				alpha: 0.0001, // 
				iterations: 1000,
				lambda: 0.0
			});

			// === Train the linear regression === //
			r_model = regression.fit(data);
		} else if (this_model["type"]=="categorical") {
			console.log("Logistic Regressions")
			// === Create the logistic regression === //
			logistic = new jsregression.LogisticRegression({
				alpha: 0.0001,
				iterations: 1000,
				lambda: 0.0
			});

			// === Train the logistic regression === //
			r_model = logistic.fit(data);		
		}

		if (r_model["theta"][0]) {
			headers = [JSON.parse(localStorage.questions)[0]["training"]["headers"]]
			var removeIndexes = [0,headers[0].length-2,headers[0].length-1]
			headers = headers.map(v => v.filter((_, i) => !removeIndexes.includes(i)))
			
			headers[0].unshift("intercept")
			//headers[0].push("intercept")
			
			console.log(data.length);
			coefficients = {}
			for (feature in headers[0]){
				coefficients[headers[0][feature]] = r_model["theta"][feature];
			}

			models[0]["trained_on"] = data.length
			models[0]["coefficients"] = coefficients

			$('#model_json').val(JSON.stringify(models[0], null, 2));
			localStorage.question = JSON.stringify(models);

			return true
		} else {
			return false
		}
	} catch (error) {
		return false		
	}

}

var equation;
function run_model(){
	console.log("Run/Update Model")
	
	feature_values = JSON.parse(localStorage.feature_values);
	model = JSON.parse(localStorage.questions)[0]
	equation = "";
	output = 0;
	output_array = []
	coefficients = JSON.parse(localStorage.questions)[0]["coefficients"];
	for (const [key, value] of Object.entries(coefficients)) {
		if (key=="intercept") {
			//console.log(String(key)+value);
			output += value
			equation += String(value)
		} else if (!key.includes("-")) {
			//console.log(String(key)+($('#'+key).html())*value*1);
			output += ($('#'+key).html())*value*1
			output_array.push(($('#'+key).html())*value*1)
			equation += " + ("+String(($('#'+key).html()))+")("+String(value)+")";
			feature_values[key] = $('#'+key).html()*1
		} else {
			if ($('#'+key.split("-")[0]).val().toLowerCase()==key.split("-")[1].toLowerCase()) {
				output += 1*value
				output_array.push(1*value)
				equation += " + (1)("+String(value)+")"
			} else {
				output += 0
				output_array.push(0)
				equation += " + (0)("+String(value)+")"
			}
			feature_values[snake_case(key.split("-")[0])] = snake_case($('#'+key.split("-")[0]).val());
		}
	}
	feature_values["note"] = $('#note').val();
	
	if (model["type"]=="continuous") {
		output = output;
		equation = String(output) + " = "  + equation;
	} else if (model["type"]=="categorical") {
		output = 100 / (1 + Math.E**(-1*output));
		equation = String(output) + " = (100)(1 /(1 + e^(-(" + equation + "))))";
	}	

	localStorage.feature_values = JSON.stringify(feature_values);

	if (model["trained_on"]>0) {
		if (model["type"]=="continuous") {
			output = Math.round(output*100)/100;
			$('#prediction_text').html(output+"<sup>&dagger;</sup>");
		} else if (model["type"]=="categorical") {
			output = Math.round(output*100)/100;
			$('#prediction_text').html("Yes ("+output+"%)<sup>&dagger;</sup>");
		}
	}

}

</script>

<!---
	Some predictions to play with:
	- How long will my run be?
	- Will I have a good sleep?
	- hours (cost) on case (time to do X)
	- value of case (win)
	- net value of case (win-cost)
	- outcome of case
	- risk score
	- expected value calculations 
--->

</HTML>